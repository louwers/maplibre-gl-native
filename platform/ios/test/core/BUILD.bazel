load("@build_bazel_rules_apple//apple:ios.bzl", "ios_application", "ios_unit_test")
load("//platform/ios/bazel:config.bzl", "BUNDLE_ID_PREFIX")
load("//bazel:flags.bzl", "CPP_FLAGS", "MAPLIBRE_FLAGS")

cc_library(
    name = "test_cpp_srcs",
    srcs = [
        "ios_test_runner.cpp",
    ],
    copts = CPP_FLAGS + MAPLIBRE_FLAGS,
    deps = [
        "//platform:ios-sdk",
        "//platform/ios/test/common:ios_test_runner_lib",
        "//test:testlib",
        "//test:tests",
    ],
)

objc_library(
    name = "test_objc_srcs",
    srcs = [
        "Tests.m",
        "iosTestRunner.h",
        "iosTestRunner.mm",
    ],
    deps = [
        "test_cpp_srcs",
        "//platform/ios/test/common:ios_test_runner_lib",
    ],
)

ios_application(
    name = "CppUnitTestsApp",
    bundle_id = "{}.maplibre.UnitTestsApp".format(BUNDLE_ID_PREFIX),
    families = ["iphone"],
    infoplists = [
        "//render-test/ios:Info.plist",
    ],
    minimum_os_version = "12.0",
    provisioning_profile = "//platform/ios:xcode_profile",
    visibility = [
        "//visibility:public",
    ],
    deps = [
        "//platform/ios/test/common:test_app_srcs",
    ],
)

ios_unit_test(
    name = "cpp_unit_tests",
    minimum_os_version = "12.0",
    test_host = "CppUnitTestsApp",
    deps = [
        "test_objc_srcs",
    ],
)
